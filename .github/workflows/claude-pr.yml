name: Claude PR Assistant

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number'
        required: true
        type: number

concurrency:
  group: claude-pr-${{ github.event.pull_request.number || inputs.pr_number }}
  cancel-in-progress: false

jobs:
  generate-description:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR has existing description
        id: check-description
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
        run: |
          BODY=$(gh pr view "$PR_NUMBER" --json body -q '.body' 2>/dev/null || echo "")
          BODY_LENGTH=${#BODY}
          HAS_STRUCTURE=$(echo "$BODY" | grep -c "^##" || true)
          if [ "$BODY_LENGTH" -gt 100 ] || [ "$HAS_STRUCTURE" -gt 0 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "PR already has a description ($BODY_LENGTH chars, $HAS_STRUCTURE headers), skipping"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "PR has minimal/no description ($BODY_LENGTH chars), will generate"
          fi

      - name: Get PR metadata
        if: steps.check-description.outputs.skip != 'true'
        id: pr-meta
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
        run: |
          PR_DATA=$(gh pr view "$PR_NUMBER" --json headRefName,baseRefName,author,title)
          echo "branch=$(echo "$PR_DATA" | jq -r '.headRefName')" >> $GITHUB_OUTPUT
          echo "base=$(echo "$PR_DATA" | jq -r '.baseRefName')" >> $GITHUB_OUTPUT
          echo "author=$(echo "$PR_DATA" | jq -r '.author.login')" >> $GITHUB_OUTPUT
          echo "title=$(echo "$PR_DATA" | jq -r '.title')" >> $GITHUB_OUTPUT

      - name: Run Claude to Generate PR Description
        if: steps.check-description.outputs.skip != 'true'
        id: claude-description
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
            BRANCH: ${{ steps.pr-meta.outputs.branch }}
            BASE: ${{ steps.pr-meta.outputs.base }}
            AUTHOR: ${{ steps.pr-meta.outputs.author }}
            CURRENT TITLE: ${{ steps.pr-meta.outputs.title }}

            YOUR TASK: Analyze this PR and UPDATE it with a title and description.
            
            IMPORTANT: You MUST execute the `gh pr edit` command at the end. Do not just output analysis.

            Steps:
            1. Run: `gh pr diff ${{ github.event.pull_request.number || inputs.pr_number }}`
            2. Run: `gh pr view ${{ github.event.pull_request.number || inputs.pr_number }}`
            3. Analyze what changed, why, and the impact
            4. EXECUTE this command to update the PR (replace placeholders):

            ```bash
            gh pr edit ${{ github.event.pull_request.number || inputs.pr_number }} \
              --title "type: brief description (max 72 chars)" \
              --body "## Summary
            Brief 1-2 sentence summary of what this PR does.

            ## Changes
            - Bullet point list of key changes
            - Be specific but concise

            ## Type
            - [ ] Bug fix
            - [ ] New feature  
            - [ ] Refactor
            - [ ] Documentation
            - [ ] Tests
            - [ ] Other

            ## Notes
            Any additional context, breaking changes, or things reviewers should know.

            ---
            *Auto-generated by Claude. Feel free to edit.*"
            ```

            Guidelines:
            - Title: conventional commits style (feat:, fix:, refactor:, docs:, chore:)
            - Check ONE type checkbox based on changes
            - YOU MUST RUN the gh pr edit command - this is required

          claude_args: '--allowed-tools "Bash(gh pr diff *)" --allowed-tools "Bash(gh pr view *)" --allowed-tools "Bash(gh pr edit *)"'

  code-review:
    needs: [generate-description]
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}

            Please review this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            Use the repository's CLAUDE.md for guidance on style and conventions. Be constructive and helpful in your feedback.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          claude_args: '--allowed-tools "Bash(gh issue view *)" --allowed-tools "Bash(gh search *)" --allowed-tools "Bash(gh issue list *)" --allowed-tools "Bash(gh pr comment *)" --allowed-tools "Bash(gh pr diff *)" --allowed-tools "Bash(gh pr view *)" --allowed-tools "Bash(gh pr list *)"'
