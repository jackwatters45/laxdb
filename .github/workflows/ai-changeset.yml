name: AI Changeset Generator

on:
  pull_request:
    types: [labeled]

concurrency:
  group: ai-changeset-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  generate-changeset:
    if: github.event.label.name == 'generate-changeset'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Generate changeset with Claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Generate a changeset for this pull request.

            PR #${{ github.event.pull_request.number }}
            Title: ${{ github.event.pull_request.title }}
            Branch: ${{ github.head_ref }} -> ${{ github.base_ref }}

            INSTRUCTIONS:
            1. Run `git diff origin/${{ github.base_ref }}...HEAD --stat` to see what files changed
            2. Determine which @laxdb/* packages are affected based on the changed files
            3. Analyze the changes to determine the semver bump:
               - patch: bug fixes, internal changes, dependency updates
               - minor: new features (backwards compatible)  
               - major: breaking changes
            4. Write a concise changelog entry (1-2 sentences)
            5. Create a changeset file using the Bash tool:
               ```
               cat > .changeset/ai-generated-$(date +%s).md << 'EOF'
               ---
               "@laxdb/package-name": patch
               ---

               Your changelog message here.
               EOF
               ```
            6. Run `bun changeset status` to validate
            7. Commit and push: `git add .changeset && git commit -m "chore: add changeset" && git push`

            Valid package names: @laxdb/core, @laxdb/api, @laxdb/web, @laxdb/ui, @laxdb/marketing, @laxdb/docs, effect-cloudflare

            After completing, comment on the PR confirming the changeset was created.

          claude_args: '--allowed-tools "Bash(git diff:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(cat:*),Bash(bun changeset:*),Bash(gh pr comment:*)"'

      - name: Remove label
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'generate-changeset'
              });
            } catch (e) {
              console.log('Could not remove label:', e.message);
            }
