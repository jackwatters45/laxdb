name: Claude PR Description

on:
  pull_request:
    types: [opened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to generate description for'
        required: true
        type: number

concurrency:
  group: claude-pr-description-${{ github.event.pull_request.number || inputs.pr_number }}
  cancel-in-progress: false

jobs:
  generate-description:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR has existing description
        id: check-description
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
        run: |
          BODY=$(gh pr view "$PR_NUMBER" --json body -q '.body' 2>/dev/null || echo "")
          BODY_LENGTH=${#BODY}
          HAS_STRUCTURE=$(echo "$BODY" | grep -c "^##" || true)
          if [ "$BODY_LENGTH" -gt 100 ] || [ "$HAS_STRUCTURE" -gt 0 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "PR already has a description ($BODY_LENGTH chars, $HAS_STRUCTURE headers), skipping"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "PR has minimal/no description ($BODY_LENGTH chars), will generate"
          fi

      - name: Get PR metadata
        if: steps.check-description.outputs.skip != 'true'
        id: pr-meta
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
        run: |
          PR_DATA=$(gh pr view "$PR_NUMBER" --json headRefName,baseRefName,author,title)
          echo "branch=$(echo "$PR_DATA" | jq -r '.headRefName')" >> $GITHUB_OUTPUT
          echo "base=$(echo "$PR_DATA" | jq -r '.baseRefName')" >> $GITHUB_OUTPUT
          echo "author=$(echo "$PR_DATA" | jq -r '.author.login')" >> $GITHUB_OUTPUT
          echo "title=$(echo "$PR_DATA" | jq -r '.title')" >> $GITHUB_OUTPUT

      - name: Run Claude to Generate PR Description
        if: steps.check-description.outputs.skip != 'true'
        id: claude-description
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
            BRANCH: ${{ steps.pr-meta.outputs.branch }}
            BASE: ${{ steps.pr-meta.outputs.base }}
            AUTHOR: ${{ steps.pr-meta.outputs.author }}
            CURRENT TITLE: ${{ steps.pr-meta.outputs.title }}

            Your task is to analyze this pull request and generate:
            1. A concise, descriptive PR title (max 72 chars)
            2. A comprehensive PR description

            Steps:
            1. Use `gh pr diff ${{ github.event.pull_request.number || inputs.pr_number }}` to see the changes
            2. Use `gh pr view ${{ github.event.pull_request.number || inputs.pr_number }}` to see current PR details
            3. Analyze the changes to understand:
               - What was changed (files, functions, components)
               - Why it was changed (bug fix, feature, refactor, etc.)
               - Impact of the changes

            Then update the PR with a well-structured description using:
            ```
            gh pr edit ${{ github.event.pull_request.number || inputs.pr_number }} \
              --title "Your Suggested Title" \
              --body "$(cat <<'EOF'
            ## Summary
            Brief 1-2 sentence summary of what this PR does.

            ## Changes
            - Bullet point list of key changes
            - Be specific but concise

            ## Type
            - [ ] Bug fix
            - [ ] New feature
            - [ ] Refactor
            - [ ] Documentation
            - [ ] Tests
            - [ ] Other

            ## Notes
            Any additional context, breaking changes, or things reviewers should know.

            ---
            *Auto-generated by Claude. Feel free to edit.*
            EOF
            )"
            ```

            Guidelines:
            - Title should follow conventional commits style (feat:, fix:, refactor:, docs:, chore:, etc.)
            - Description should be clear and helpful for reviewers
            - Check the appropriate type checkbox based on the changes
            - Reference the repository's CLAUDE.md for style conventions if available

          claude_args: '--allowed-tools "Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr edit:*)"'
